# -*- coding: utf-8 -*-

require_relative 'spec_helper'

ChefSpec::Coverage.start! { add_filter 'gitrob' }

require 'chef/application'

describe 'pentester::gitrob' do
  let(:subject) do
    ChefSpec::SoloRunner.new(file_cache_path: '/var/chef/cache') do |node|
      node.set['postgresql']['password']['postgres'] = 'postgres'
      node.set['postgresql']['config'] = {}
    end.converge(described_recipe)
  end

  before do
    stub_command('ls /recovery.conf').and_return(true)
  end

  it 'installs gem_package[gitrob]' do
    expect(subject).to install_gem_package('gitrob')
  end

  it 'creates template[/root/.gitrobrc]' do
    config_file = '/root/.gitrobrc'
    expect(subject).to create_template(config_file)
      .with(source: 'gitrobrc.erb')

    [%r{^sql_connection_uri: postgres://gitrob:gitrob@localhost:5432/gitrob$},
     /^github_access_tokens:\n- aabbccddeeff00112233445566778899$/].each do |m|
      expect(subject).to render_file(config_file).with_content(m)
    end
  end

  it 'includes recipe[postgresql::server]' do
    expect(subject).to include_recipe('postgresql::server')
  end

  it 'includes recipe[database::postgresql]' do
    expect(subject).to include_recipe('database::postgresql')
  end

  it 'creates postgresql_database_user[gitrob]' do
    expect(subject).to create_postgresql_database_user('gitrob')
      .with(password: 'gitrob')
  end

  it 'creates postgresql_database[gitrob]' do
    expect(subject).to create_postgresql_database('gitrob')
  end

  context 'without postgresql installation' do
    let(:subject) do
      ChefSpec::SoloRunner.new do |node|
        node.set['pentester']['gitrob']['install_pgsql'] = false
      end.converge(described_recipe)
    end

    it 'does not includes recipe[postgresql::server]' do
      expect(subject).to_not include_recipe('postgresql::server')
    end
  end

  context 'on debian 7.x' do
    let(:subject) do
      ChefSpec::SoloRunner.new(
        platform: 'debian',
        version: '7.2') do |node|
        node.set['pentester']['gitrob']['install_pgsql'] = false
      end.converge(described_recipe)
    end

    ['ruby1.9.3',
     'ruby-dev',
     'postgresql-server-dev-9.1'].each do |pkg|
      it "installs package[#{pkg}]" do
        expect(subject).to install_package(pkg)
      end
    end
  end

  context 'on debian 8.x' do
    let(:subject) do
      ChefSpec::SoloRunner.new(
        platform: 'debian',
        version: '8.1') do |node|
        node.set['pentester']['gitrob']['install_pgsql'] = false
      end.converge(described_recipe)
    end

    ['ruby2.1',
     'ruby2.1-dev',
     'postgresql-server-dev-9.4'].each do |pkg|
      it "installs package[#{pkg}]" do
        expect(subject).to install_package(pkg)
      end
    end
  end
end
